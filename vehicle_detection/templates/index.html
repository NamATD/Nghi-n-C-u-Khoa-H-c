<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Detection System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f0f0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .main-video {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .video-title {
        font-size: 1.2em;
        margin-bottom: 10px;
        color: #444;
      }
      .video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
        background: #000;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
      }
      .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #000;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }
      .status {
        font-size: 0.9em;
        color: #666;
      }
      .status.active {
        color: #28a745;
      }
      .status.inactive {
        color: #dc3545;
      }
      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s;
      }
      button.start {
        background-color: #28a745;
        color: white;
      }
      button.stop {
        background-color: #dc3545;
        color: white;
      }
      button:hover {
        opacity: 0.9;
      }
      .stats {
        font-size: 0.8em;
        color: #666;
        margin-top: 5px;
      }
      .camera-selector {
        margin-bottom: 20px;
        text-align: center;
      }
      .camera-selector select {
        padding: 8px;
        font-size: 1em;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Vehicle Detection System</h1>
      <div class="camera-selector">
        <select id="cameraSelect" onchange="switchCamera(this.value)">
          <option value="">Select Camera</option>
          <option value="1">Camera 1</option>
          <option value="2">Camera 2</option>
          <option value="3">Camera 3</option>
          <option value="4">Camera 4</option>
        </select>
      </div>
      <div class="main-video">
        <div class="video-title">Selected Camera Feed</div>
        <div class="video-container">
          <video
            id="main-video"
            autoplay
            playsinline
            style="display: none"
          ></video>
        </div>
        <div class="controls">
          <div class="status inactive" id="main-status">Inactive</div>
          <button class="start" onclick="toggleMainCamera()">Start</button>
        </div>
        <div class="stats" id="main-stats">No vehicles detected</div>
      </div>
    </div>

    <script>
      // Kết nối Socket.IO
      const socket = io();
      const cameras = {};
      let currentCameraId = null;
      let mainCameraRunning = false;

      // Khởi tạo giao diện camera
      function initializeCameras() {
        fetch("/api/cameras")
          .then((response) => response.json())
          .then((data) => {
            data.cameras.forEach((camera) => {
              cameras[camera.id] = {
                status: false,
              };
            });
          })
          .catch((error) => console.error("Error fetching cameras:", error));
      }

      // Chuyển đổi camera
      function switchCamera(cameraId) {
        if (!cameraId) {
          document.getElementById("main-video").style.display = "none";
          document.getElementById("main-status").textContent = "Inactive";
          document.getElementById("main-status").className = "status inactive";
          document.getElementById("main-stats").textContent =
            "No vehicles detected";
          currentCameraId = null;
          return;
        }

        cameraId = parseInt(cameraId);
        currentCameraId = cameraId;

        // Gọi API để đặt camera đang được xem
        fetch(`/api/camera/${cameraId}/set_active`, { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            console.log(data.message);
          })
          .catch((error) =>
            console.error("Error setting active camera:", error)
          );

        // Nếu camera đang chạy, hiển thị trạng thái
        if (cameras[cameraId] && cameras[cameraId].status) {
          document.getElementById("main-status").textContent = "Active";
          document.getElementById("main-status").className = "status active";
          document.getElementById("main-video").style.display = "block";
        }
      }

      // Xử lý start/stop camera chính
      function toggleMainCamera() {
        if (!currentCameraId) return;

        const button = document.querySelector(".main-video button");
        const status = document.getElementById("main-status");
        const videoElement = document.getElementById("main-video");

        if (!mainCameraRunning) {
          // Start camera
          fetch(`/api/camera/${currentCameraId}/start`, { method: "POST" })
            .then((response) => response.json())
            .then((data) => {
              mainCameraRunning = true;
              button.textContent = "Stop";
              button.className = "stop";
              status.textContent = "Active";
              status.className = "status active";
              videoElement.style.display = "block";
              cameras[currentCameraId].status = true;

              // Cập nhật source của video
              videoElement.src = `/api/camera/${currentCameraId}/video_feed`;
            })
            .catch((error) => console.error("Error starting camera:", error));
        } else {
          // Stop camera
          if (cameras[currentCameraId] && cameras[currentCameraId].status) {
            fetch(`/api/camera/${currentCameraId}/stop`, { method: "POST" })
              .then((response) => response.json())
              .then((data) => {
                mainCameraRunning = false;
                button.textContent = "Start";
                button.className = "start";
                status.textContent = "Inactive";
                status.className = "status inactive";
                videoElement.style.display = "none";
                videoElement.src = "";
                cameras[currentCameraId].status = false;
              })
              .catch((error) => console.error("Error stopping camera:", error));
          }
        }
      }

      // Lắng nghe cập nhật từ server
      socket.on("camera_update", function (data) {
        const cameraId = data.camera_id;
        const statsElement = document.getElementById("main-stats");

        // Cập nhật thống kê cho camera đang được chọn
        if (cameraId === currentCameraId && statsElement && data.detections) {
          const vehicleCount = data.detections.length;
          statsElement.textContent = `Detected ${vehicleCount} vehicles`;
        }
      });

      // Khởi tạo khi trang được tải
      document.addEventListener("DOMContentLoaded", initializeCameras);
    </script>
  </body>
</html>
